name: Generar sitio completo (index + obras + sitemap)

on:
  push:
    branches: [ main ]   # Se ejecuta al hacer push en la rama main
  workflow_dispatch:     # Permite lanzarlo manualmente desde la interfaz de GitHub

permissions:
  contents: write        # üîë Permite al workflow hacer commit y push de cambios

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout del repositorio con historial completo
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # Necesario para poder hacer pull/rebase

      # 2Ô∏è‚É£ Configurar Node.js
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # 3Ô∏è‚É£ Instalar dependencias necesarias
      - name: Instalar dependencias
        run: npm install fast-xml-parser --no-save

      # 4Ô∏è‚É£ Bloque A: Generar JSON-LD e insertarlo en index.html
      - name: Generar JSON-LD en index.html
        run: node scripts/xmlToJsonLd.js

      # 5Ô∏è‚É£ Bloque B: Generar HTML de obras y sitemap
      - name: Generar HTML de obras y sitemap
        run: node scripts/buildPages.js

      # --------------------------
      # Paso a√±adido: ejecutar el script Python que genera versiones WebP responsivas
      # - Ejecuta generate_responsive_images.py desde la ra√≠z del repo.
      # - El script recorre img/ y crea versiones optimizadas en subcarpetas por imagen.
      # - No re-genera versiones ya existentes; solo crea las que falten.
      # - Aseg√∫rate de que generate_responsive_images.py est√© en la rama main.
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Instalar Pillow
        run: python -m pip install --upgrade pip Pillow

      - name: Ejecutar generador de im√°genes responsivas
        run: |
          # Ejecuta el script que crea <imagen>-900w.webp, -600w.webp, -300w.webp dentro de carpetas por imagen.
          # El script evita sobrescribir archivos existentes y gestiona EXIF y transparencia.
          python generate_responsive_images.py -d .

      # 6Ô∏è‚É£ Commit y push de todos los cambios generados
      - name: Commit y push cambios
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          # A√±adir todos los posibles cambios generados por los pasos anteriores (index, obras, sitemap, im√°genes)
          git add -A
          git diff --cached --quiet || git commit -m "Build: actualizar index y obras y/o im√°genes generadas"
          git pull origin main --rebase   # üîë Trae cambios remotos antes de empujar
          git push
